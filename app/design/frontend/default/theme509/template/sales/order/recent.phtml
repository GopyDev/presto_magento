<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<style>
#my-orders-table{
/*width:100%;*/
font-size:11px;
border:1px solid #000;
}
th{
    /*padding: 10px;*/
	padding: 0 0 10px;
	width: 18%;
   /* width: 100px;*/
}
.heading{
background-color:#3f7e19;
}
.header
{
   height:auto !important;
}
.heading-text{color:#fff !important;}
.odd{background-color:#eee;}
.inner-items-table{
box-shadow: 10px 10px 5px #888888;
	border:1px solid #000000;
	-moz-border-radius-bottomleft:9px;
	-webkit-border-bottom-left-radius:9px;
	border-bottom-left-radius:9px;
	-moz-border-radius-bottomright:9px;
	-webkit-border-bottom-right-radius:9px;
	border-bottom-right-radius:9px;
	-moz-border-radius-topright:9px;
	-webkit-border-top-right-radius:9px;
	border-top-right-radius:9px;
	-moz-border-radius-topleft:9px;
	-webkit-border-top-left-radius:9px;
	border-top-left-radius:9px;
}
</style>

<!--Files for expand -->


  <style type="text/css">
  .main-table{
  width:100%;
  }
    .mycontainer {
}
.mycontainer div {
}
.mycontainer .header {
    cursor: pointer;
	color:#5a5959;
}
.mycontainer .content {
    display: none;
    padding : 5px;
}
.mycontainer >.header{
font-size:12px;
font-weight:400px;
color:#65ae01;
}
.nobr > a{font-size:12px;}
.inner-heading{background-color:#3f7e19}
.rows{background-color:#eee;}
.inner-heading.odd > th {color: #fff !important;}
.inner-heading.even > th {color: #fff !important;}
.data-table th{font-weight:400px !important;}
@media screen and (min-width: 641px) {
  .my-account table tr td {
      padding:5px !important;
	  vertical-align:top !important;
	  text-align:left !important;
  }
   .my-account table tr th {
      padding:5px !important;
   }
}

@media screen and (max-width: 640px) {
	table {
		overflow-x: auto;
		display: block;
		width:auto;
	}
	 thead tr {
		/*position: absolute;*/
		top: -9999px;
		left: -9999px;
	}
		/* Force table to not be like tables anymore */
	 table,
	 thead,
	 tbody,
	 th,
	 td,
	 tr {
		display: block;

	}
	.heading{display:none;}
    .inner-heading{display:none;}
	.inner-items-table {
		overflow-x: auto;
		display: block;
		width:80%;
		 overflow: auto;
	}

	.even > td {
    text-align: center !important;
	}
	.odd > td {
    text-align: center !important;
	}
	.inner-items-table{margin-left:23px;}
	#my-orders-table{width:88% important;}
	.inner-heading{display:none !important;}
	#my-orders-table > thead {display:block !important;}
	.sepratorMobile{display:block;}
}
@media only screen and (min-width:640px) and (max-width: 980px)
{
	.custom-order
	{
		margin-left:-300px;
	}
}

  </style>



<script type="text/javascript">//<![CDATA[

jQuery(window).load(function(){
jQuery(".header").click(function () {
//debugger;
    jQueryheader = jQuery(this);
    //getting the next element
    jQuerycontent = jQueryheader.next();
    //open up the content needed - toggle the slide- if visible, slide up, if not slidedown.
    jQuerycontent.slideToggle(300, function () {
        //execute this after slideToggle is done
        //change text of header based on visibility of content div
        jQueryheader.text(function () {
            //change text based on condition
			//jQuery('.content').show();
            return jQuerycontent.is(":visible") ? "Collapse All" : "View Order";

        });
    });

});
});
//]]>
 /* jQuery(document).ready(function() {
        jQuery('.header').click(function() {
                jQuery('.content').toggle("slide");
        });
    }); */
</script>
<!--End files expand -->

<div class="box-account box-recent">
<?php $_orders = $this->getOrders(); ?>
    <div class="page-title">
        <h2 style="float:left;margin-right:20px;"><?php echo $this->__('Recent Orders') ?></h2>
        <?php if( sizeof($_orders->getItems()) > 0 ): ?>
		<a href="<?php echo $this->getUrl('sales/order/history') ?>" style="margin-top:2px;"><?php echo $this->__('View All') ?></a><?php endif; ?>
		<div style="color:red;font-size:11px;font-weight:bold;margin-top:10px;margin-bottom:10px;"> Note :- Estimated Time of Arrival (ETA) Is Displayed For Courtesy Purposes Only. This Time Is Subject to Change Without Notice. Delivery May Occur At Any Time Within the Selected Delivery Window, And A No-Show Fee Will Be Assessed If The Delivery Cannot Be Made. Thank You For Your Understanding! 		</div>
    </div>
<?php if( sizeof($_orders->getItems()) > 0 ): ?>
    <table  id="my-orders-table" cellspacing="5" cellpadding="5" class="main-table">
    <col width="1" />
    <col width="1" />
    <col />
    <col width="1" />
    <col width="1" />
    <col width="1" />
        <thead>
            <tr class="heading">
                <th class="heading-text" style="width:auto !important;" ><?php echo $this->__('Order #') ?></th>
                <th class="heading-text" style="width:120px !important;"><?php echo $this->__('Order Date') ?></th>
     			<th class="heading-text" style="width:260px !important;" ><?php echo $this->__('Delivery Date/Time')?></th>
                <th class="heading-text" style="width:170px !important;" ><?php echo $this->__('Ship To') ?></th>
                <th class="heading-text" style="width:90px !important;" ><span class="nobr"><?php echo $this->__('Order Total') ?></span></th>
                <th class="heading-text" style="text-align:center;"><span class="nobr"><?php echo $this->__('') ?></span></th>
               <?php /*?> <th><?php echo $this->__('Status') ?></th><?php */?>
                <th class="heading-text">&nbsp;</th>
            </tr>
        </thead>
        <tbody>
            <?php
			$count = 1;
			foreach ($_orders as $_order): ?>
                <tr class="rows" style="border-bottom:1px solid #000;">
                    <td class="order-id"><?php echo $_order->getRealOrderId() ?></td>
                    <td class="order-date"><span class="nobr"><?php echo $this->formatDate($_order->getCreatedAtStoreDate()) ?></span></td>
                    <td><?php
					 $resource = Mage::getSingleton('core/resource');
					 $readConnection = $resource->getConnection('core_read');
					 $table = $resource->getTableName('shipping_delivery_window');
					 $roid=$_order->getRealOrderId();
					 // $roid='100005357';
					 $query = "select * from mg_shipping_delivery_window where order_number ='".$roid."'";
					 $result = $readConnection->fetchAll($query);
				     foreach($result as $row ){

						$a = explode('|',$row['window']);
						$array = sizeof($a);
						if($array == '2'){
						//echo $row['window'];

							$a[1];
							$date = str_replace('_','/',$a[1]);
								list($dd,$mm,$yy) = explode("/", $date);
								$yy = substr($yy,2,4);
								echo $mm.'/'.$dd.'/'.$yy;
							echo '<br />';
							$a[0];
							$time = str_replace('_',':',$a[0]);
							$time1 = str_replace('pm:','pm - ',$time);
							echo $time1;

						} else{
							$row['window'];
							$date = str_replace('_','/',$row['window']);
							//echo $date ;


								list($dd,$mm,$yy) = explode("/", $date);
								$yy = substr($yy,2,4);

								echo $mm.'/'.$dd.'/'.$yy;
							}

							if($row["estt"]!="")
							{
							?>
							   <div style="color:#333;font-size:11px;font-weight:bold;">

							  <?php
							  $time = date("H:i", strtotime($row["estt"]));
							  $tod = explode(":",$time);
							  $minutes = $tod[1];
							  if($minutes <= 30)
							  {
							    $minutes = 30;
							  }
							  else if($minutes > 30)
							  {
							    $minutes = 00;
								$tod[0] = $tod[0] + 1 ;
							  }
							  else if($minutes==00)
							  {
							    $minutes = 00;
							  }

							  $time = $tod[0].":".$minutes;
							  $besttime = date('g:i a', strtotime($time));
							  ?>

							  <?php
							  $time = strtotime($time);

                              $startTime = date("H:i", strtotime('-30 minutes', $time));
							  $realtime = date('g:i a', strtotime($startTime));

                              ?>
							   ETA (Approx) : <?php echo $realtime; ?> - <?php echo $besttime; ?>
							   </div>
							<?php }

							}
					 ?></td>
                    <td class="order-ship"><?php echo $_order->getShippingAddress() ? $this->htmlEscape($_order->getShippingAddress()->getName()) : '&nbsp;' ?></td>
                    <td class="order-total" align="center" style="text-align:left;"><?php echo $_order->formatPrice($_order->getGrandTotal()) ?></td>
                  <?php /*?>  <td class="order-status"><em><?php echo $_order->getStatusLabel() ?></em></td><?php */?>
			<td class="order-edit" align="center" style="text-align:center;font-size:12px;padding:2px;"><a href="<?php echo Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_WEB).'Pulsestorm_Custompage/?ordernumber='.$_order->getIncrementId().'';?>">Change <br/>Delivery Time</a></td>
                    <td style="width:auto;">
                        <span class="nobr" style="width:auto;">
                        <a href="<?php echo $this->getViewUrl($_order) ?>"><?php echo $this->__('View Invoice') ?></a> |
                        <?php if ($this->helper('sales/reorder')->canReorder($_order)) : ?>
                            <!--<span class="separator">|</span>--> <br/><a href="<?php echo $this->getReorderUrl($_order) ?>"><?php echo $this->__('Reorder Entire Order') ?></a> |
                        <?php endif ?>
                        </span>
                        <br/>
                        <?php
								Mage::app();
								$orderNumber = $_order->getRealOrderId();
								$order = Mage::getModel('sales/order')->loadByIncrementId($orderNumber);
								$orderItems = $order->getItemsCollection();
				         ?>
                        	<div class="mycontainer" style="height:auto;">
				 <div class="header" id="myheader" style="font-size:12px;font-weight:400px;height:auto;">View Order</div>
				<div class="content custom-order" style="display:none;margin-top:10px;">
			    <input type="hidden" name="form_key" value="<?php echo $formKey; ?>" />
				<table class="data-table inner-items-table" id="my-orders-table">
				<thead>
				<tr class="inner-heading" style="background-color:#3f7e19;">
					<th align="center" style="text-align:center!important">Image</th>
					<th>Product Name</th>
					<th align="center" style="text-align:center!important">Unit Price</th>
					<th align="center" style="text-align:center!important">Qty</th>
					<th align="center" style="text-align:center!important">Subtotal</th>
					<th align="center" style="text-align:center!important">Add to Cart</th>
				</tr>
			    <?php
						foreach ($orderItems as $item){
							$product_id = $item->product_id;
							$product_sku = $item->sku;
							$product_name = $item->getName();
							$product_qty = $item->getQty();
							$_product = Mage::getModel('catalog/product')->load($product_id);
							$cats = $_product->getCategoryIds();
							$category_id = $cats[0]; // just grab the first id
							$category = Mage::getModel('catalog/category')->load($category_id);
							$category_name = $category->getName();
							$product = Mage::getModel('catalog/product')->load($product_id);
							$full_path_url = Mage::helper('catalog/image')->init($product, 'thumbnail');
							$product->getUrlPath();
							$product->getTypeId();
					?>
					<tr style="background-color:#eee !important; ">
							<?php
								$formKey = Mage::getSingleton('core/session')->getFormKey();
							?>
						<td ><img src="<?php echo Mage::helper('catalog/image')->init($product, 'small_image')->resize(100,100);?>" width="100" alt=""></td>
						<td class="product_name"><a href="<?php  echo $product->getUrlInStore(); ?>"><?php echo $product_name?></a>
						</td>
						<td align="center" style="text-align:center!important"><?php echo "$".number_format($item->getPrice(),2);?></td>
						<td style="color:#7b7b7b;text-align:center!important" align="center"><?php echo number_format($item->getQtyOrdered(),0);?></td>
						<td><?php echo "$".number_format($item->getPrice()*$item->getQtyOrdered(),2);?></td >
						<td style="text-align:center;">
						<input type="hidden" name="qty_<?php echo $product_id;?>" value="<?php echo $item->getQtyOrdered();?>" />
						<input type="hidden" name="tmp" id="tmp" value="<?php echo number_format($item->getQtyOrdered(),0);?>" />
						<?php
						$url = Mage::getBaseUrl(Mage_Core_Model_Store::URL_TYPE_WEB).'checkout/cart/add/uenc/'.$formKey.'/product/'.$product_id.'/';
						?>
						<!--<button type="button" title="<?php echo $this->__('Add to Cart') ?>" class="button btn-cart" onclick="setaLocation('<?php //echo $url; ?>',<?php //echo $product_id;?>,'<?php //echo number_format($item->getQtyOrdered(),0);?>')"><span><span><?php //echo $this->__('Add to Cart') ?></span></span></button> -->
						<?php
							$product = Mage::getModel('catalog/product')->load($_product->getId());
							$qty = number_format($product->getStockItem()->getQty(),0);
							//echo "Qty is ".$qty;
							if($qty >0 && $product->getStatus() == 1){
						?>
						 <button type="button" title="<?php echo $this->__('Add to Cart') ?>" class="button btn-cart" onclick="setaLocation('<?php echo $url; ?>',<?php echo $_product->getId();?>,'<?php echo number_format($item->getQtyOrdered(),0);?>')"><span><span><?php echo $this->__('Add to Cart') ?></span></span></button>
						 <?php
							}else{
								echo '<span style="color:red;">Not Currently Available</span>';
							}
						 ?>
						</td>

					</tr>
				 </form>
					<?php
						}
			?>
				</table>
				</div>
			</div>

            <?php if($count != 5) {
				?>
				<!-- <hr class="sepratorMobile"/> -->
				<?php
					}
				?>
                    </td>
                </tr>
            <?php
			$count ++;
			endforeach; ?>
        </tbody>
    </table>
    <script type="text/javascript">decorateTable('my-orders-table')</script>
<?php else: ?>
    <p><?php echo $this->__('You have placed no orders.'); ?></p>
<?php endif; ?>
</div>
 <script type="text/javascript">
function setaLocation(url,pid,qty){
var totalurl=url+'qty/'+qty;
setLocation(totalurl);
}
</script>